import sys
import requests                                                                                                                                                                                                    
import numpy                                                                                                                                                                                                       
import time                                                                                                                                                                                                        
from bs4 import BeautifulSoup, SoupStrainer                                                                                                                                                                        
from urllib.parse import urlparse                                                                                                                                                                                  
                                                                                                                                                                                                                   
#-----------------------------------------------------------------------------                                                                                                                                     
# SCRAPING FUNCTIONS                                                                                                                                                                                               
#-----------------------------------------------------------------------------                                                                                                                                     
def getUrl(url, params={}):                                                                                                                                                                                        
    headers = {                                                                                                                                                                                                    
#            'user-agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_11_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/53.0.2785.143 Safari/537.36',                                                            
            'user-agent': getUA(),                                                                                                                                                                                 
            'referer': getRef(url)                                                                                                                                                                                 
            }                                                                                                                                                                                                      
                                                                                                                                                                                                                   
    print(getRef(url))                                                                                                                                                                                             
    r = requests.get(url, headers=headers, params=params, proxies=getProxies(), timeout=5)                                                                                                                         
                                                                                                                                                                                                                   
    text = None                                                                                                                                                                                                    
                                                                                                                                                                                                                   
    # make sure that the page exist                                                                                                                                                                                
    if r.status_code == 200:                                                                                                                                                                                       
        text = r.text                                                                                                                                                                                              
                                                                                                                                                                                                                   
    return text                                                                                                                                                                                                    
                                                                                                                                                                                                                   
def getUA():                                                                                                                                                                                                       
    ua = ''                                                                                                                                                                                                        
    ua_file = 'ua_file.txt'                                                                                                                                                                                        
    try:                                                                                                                                                                                                           
        with open(ua_file) as f:                                                                                                                                                                                   
            lines = f.readlines()                                                                                                                                                                                  
        if len(lines) > 0:                                                                                                                                                                                         
            prng = numpy.random.RandomState()                                                                                                                                                                      
            index = prng.permutation(len(lines) - 1)                                                                                                                                                               
            idx = numpy.asarray(index, dtype=numpy.integer)[0]                                                                                                                                                     
            ua = lines[int(idx)]                                                                                                                                                                                   
    except Exception as ex:
        print('Exception in random_ua')
        print(str(ex))
    finally:
        return ua.strip()

def getRef(url):                                                                                                                                                                                                   
    ref = 'https://www.google.com'                                                                                                                                                                                 
    hostname = urlparse(url).hostname                                                                                                                                                                              
    tld = hostname.split('.')[-1]                                                                                                                                                                                  
    if not tld == "com":                                                                                                                                                                                           
        ref += "." + tld                                                                                                                                                                                           
    return ref                                                                                                                                                                                                     
                                                                                                                                                                                                                   
def getProxies():                                                                                                                                                                                                  
    proxies = {}                                                                                                                                                                                                   
                                                                                                                                                                                                                   
    proxy_file = 'proxy_file.txt'                                                                                                                                                                                  
    proxy = ''                                                                                                                                                                                                     
    try:                                                                                                                                                                                                           
        with open(proxy_file) as f:                                                                                                                                                                                
            lines = f.readlines()                                                                                                                                                                                  
        if len(lines) > 0:                                                                                                                                                                                         
            prng = numpy.random.RandomState()                                                                                                                                                                      
            index = prng.permutation(len(lines) - 1)                                                                                                                                                               
            idx = numpy.asarray(index, dtype=numpy.integer)[0]                                                                                                                                                     
            proxy = lines[int(idx)]                                                                                                                                                                                
    except Exception as ex:                                                                                                                                                                                        
        print('Exception in random_proxy')                                                                                                                                                                         
        print(str(ex))                                                                                                                                                                                             
    finally:                                                                                                                                                                                                       
        proxies['http'] = proxy.strip()                                                                                                                                                                            
                                                                                                                                                                                                                   
    proxy_file = 'proxy_ssl_file.txt'                                                                                                                                                                              
    proxy = ''                                                                                                                                                                                                     
    try:                                                                                                                                                                                                           
        with open(proxy_file) as f:                                                                                                                                                                                
            lines = f.readlines()                                                                                                                                                                                  
        if len(lines) > 0:                                                                                                                                                                                         
            prng = numpy.random.RandomState()                                                                                                                                                                      
            index = prng.permutation(len(lines) - 1)                                                                                                                                                               
            idx = numpy.asarray(index, dtype=numpy.integer)[0]                                                                                                                                                     
            proxy = lines[int(idx)]                                                                                                                                                                                
    except Exception as ex:                                                                                                                                                                                        
        print('Exception in random_proxy')  
        print(str(ex))
    finally:
        proxies['https'] = proxy.strip()

    print(proxies)
    return proxies

def pause():
    delays = [2, 4, 6, 8, 10, 12, 14, 16, 18, 20]
    delay = numpy.random.choice(delays)
    time.sleep(delay)

#-----------------------------------------------------------------------------
# PARSING FUNCTIONS
#-----------------------------------------------------------------------------
def getLinks(text, url=""):
    if url and url[-1] == "/":
        url = url[:-1]

    links = []
    if text:
        for link in BeautifulSoup(text, "html.parser", parse_only=SoupStrainer("a", href=True)):
            if link.has_attr('href'):
                if (link['href']):
                    href = link['href'].strip()
                    if not href.startswith("http://") and not href.startswith("https://") and not href.startswith("mailto:") and not href.startswith("tel:"):                                                     
                        if not href.startswith('/'):
                            href = "/" + href
                        href = url + href
                    links.append(href)
    return links

#-----------------------------------------------------------------------------
# MAIN
#-----------------------------------------------------------------------------
if __name__ == "__main__":
    def usage():
        print("python %s <url>" % (sys.argv[0]))

    if len(sys.argv) != 2:
        usage()
        sys.exit(0)

    url = sys.argv[1]
    params = {}

    text = getUrl(url, params)

    print(getLinks(text, url))
